# Исправление проблем с аватарами в LootNest

## Проблема

Возникла проблема с загрузкой и отображением аватаров. Основные причины:

1. Неправильная структура пути для аватаров (`avatars/avatars/` вместо `userId/fileName`)
2. Проблемы с доступом к бакету из-за неправильных политик RLS
3. Бакет для аватаров не существует или не настроен правильно
4. Ошибка при выполнении SQL-запроса: `function pg_get_expr(text, oid) does not exist`

## Выполненные изменения

1. **Обновлен файл `supabase.ts`**:
   - Улучшена функция `ensureAvatarBucketExists` для гарантированного создания бакета
   - Добавлена функция `fixAvatarUrl` для исправления дублирования путей
   - Улучшена обработка ошибок в функциях работы с аватарами

2. **Обновлен файл `profile/page.tsx`**:
   - Добавлены подробные логи для отладки
   - Исправлена структура пути для загрузки аватаров: `userId/fileName`
   - Улучшена обработка ошибок при загрузке аватаров

3. **Создан файл `avatar-policies-fix.sql` с исправленными политиками для хранилища**:
   - Проверка существования бакета для аватаров
   - Удаление старых политик для избежания конфликтов
   - Создание новых политик с правильной структурой пути
   - Исправлена ошибка с функцией `pg_get_expr`

4. **Обновлены файлы бэкенда**:
   - Добавлены методы для работы с аватарами в `supabase.service.ts`
   - Добавлены методы для работы с аватарами в `users.service.ts`
   - Добавлены эндпоинты для работы с аватарами в `users.controller.ts`

## План действий

1. **Создайте бакет вручную в консоли Supabase**:
   - Войдите в консоль Supabase для вашего проекта: https://supabase.com/dashboard
   - Выберите ваш проект
   - Перейдите в раздел Storage (в левом меню)
   - Нажмите "Create bucket"
   - Введите имя "avatars"
   - Включите опцию "Public bucket"
   - Нажмите "Create bucket"

2. **Выполните SQL запросы в консоли Supabase**:
   - Перейдите в раздел SQL Editor (в левом меню)
   - Скопируйте и выполните содержимое файла `avatar-policies-fix.sql`
   - Проверьте результаты выполнения запроса - должны быть созданы политики

3. **Проверьте настройки хранилища в Supabase**:
   - Перейдите в раздел Storage в консоли Supabase
   - Убедитесь, что бакет "avatars" существует
   - Проверьте, что бакет имеет публичный доступ (Public bucket)
   - Проверьте, что политики RLS настроены правильно

4. **Перезапустите приложение**:
   ```bash
   npm run dev
   ```

5. **Проверьте загрузку аватаров**:
   - Войдите в свой аккаунт
   - Перейдите на страницу профиля
   - Попробуйте загрузить новый аватар
   - Проверьте отладочную информацию под аватаром на странице профиля

## Структура пути для аватаров

### Правильная структура:
```
userId/fileName
```

Например:
```
bd1f3206-0b47-4b4e-bb03-0128c31b301c/avatar-1750625748427.jpg
```

### Неправильная структура (старая):
```
avatars/avatars/avatar-userId-timestamp.jpg
```

## Диагностика проблем

Если проблемы с аватарами остаются, проверьте следующее:

1. **Проверьте консоль браузера**:
   - Откройте инструменты разработчика (F12)
   - Перейдите на вкладку Console
   - Посмотрите ошибки, связанные с загрузкой аватаров

2. **Проверьте сетевые запросы**:
   - Откройте вкладку Network в инструментах разработчика
   - Отфильтруйте запросы по "storage" или "avatars"
   - Проверьте статус ответов на запросы к хранилищу

3. **Проверьте политики RLS в Supabase**:
   - Выполните SQL запрос для проверки политик:
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'objects' AND schemaname = 'storage';
   ```

4. **Проверьте бакет в Supabase**:
   - Выполните SQL запрос для проверки бакета:
   ```sql
   SELECT * FROM storage.buckets WHERE id = 'avatars';
   ```

5. **Проверьте существующие файлы в бакете**:
   - В консоли Supabase перейдите в раздел Storage
   - Выберите бакет "avatars"
   - Проверьте структуру путей файлов
   - Убедитесь, что пути соответствуют формату `userId/fileName`

6. **Проверьте URL аватаров в профилях**:
   - Выполните SQL запрос для проверки URL аватаров:
   ```sql
   SELECT id, avatar_url FROM profiles WHERE avatar_url IS NOT NULL;
   ```
   - Убедитесь, что URL соответствуют структуре `userId/fileName`

7. **Если URL аватаров неправильные, исправьте их**:
   ```sql
   UPDATE profiles 
   SET avatar_url = REPLACE(avatar_url, 'avatars/avatars/', 'avatars/')
   WHERE avatar_url LIKE '%avatars/avatars/%';
   ```

## Дополнительные улучшения

1. Добавлено кэширование с параметром времени для обхода кэширования браузера
2. Улучшена обработка ошибок при загрузке аватаров
3. Добавлены подробные логи для отладки
4. Исправлен компонент логотипа для оптимизации LCP 